# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Contributor: Aiden Grossman <agrossman154@yahoo.com>
# Maintainer:
pkgname=vtk
pkgver=9.5.2
pkgrel=0
pkgdesc="A software system for 3D computer graphics, image processing and visualization"
url="https://vtk.org/"
# s390x blocked by netcdf
arch="all !s390x"
license="BSD-3-Clause"
depends_dev="
  blosc-dev
	boost-dev
	curl-dev
	double-conversion-dev
	doxygen
	eigen-dev
	expat-dev
	exprtk
	fast_float
	ffmpeg-dev
	fmt-dev
	freetype-dev
	gdal-dev
	glew-dev
	hdf5-dev
	jpeg-dev
	jsoncpp-dev
	libaec-dev
	libharu-dev
	libogg-dev
	libpng-dev
	libtheora-dev
	libx11-dev
	libxcursor-dev
	libxml2-dev
	lz4-dev
	netcdf-dev
	nlohmann-json
	onetbb-dev
	openmpi-dev
	openvdb-dev
	pdal-dev
	pegtl
	proj-dev
	pugixml-dev
	sqlite-dev
	tiff-dev
	tk-dev
	unixodbc-dev
	xz-dev
	zlib-dev
	"
makedepends="$depends_dev
	cmake
	samurai
	"
checkdepends="
	xvfb-run
	mesa-dri-gallium
	"
subpackages="$pkgname-doc $pkgname-dev"
source="
	https://www.vtk.org/files/release/${pkgver%.*}/VTK-$pkgver.tar.gz
	https://www.vtk.org/files/release/${pkgver%.*}/VTKData-$pkgver.tar.gz
	disable-tests.patch
	external_fastfloat.patch
	loongarch64.patch
	"
builddir="$srcdir/VTK-$pkgver"

case "$CARCH" in
# Tests on RISC-V should be re-enabled when llvmpipe has proper RISC-V support.
# cf. https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/26018
# Test fail on all architecures
riscv64|loongarch64|*) options="$options !check" ;;
esac

# Use External disabled on dependencies with issues, use vendored for now
build() {
	CXXFLAGS="$CXXFLAGS -DLOGURU_STACKTRACES=0" \
	cmake -B build -G Ninja \
		-Wno-dev \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DVTK_BUILD_TESTING="$(want_check && echo ON || echo OFF)" \
		-DVTK_PYTHON_VERSION="3" \
		-DVTK_USE_LARGE_DATA=OFF \
		-DVTK_MODULE_ENABLE_VTK_IOOpenVDB=WANT \
		-DVTK_MODULE_ENABLE_VTK_RenderingExternal=WANT \
		-DVTK_MODULE_USE_EXTERNAL_VTK_cgns=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_cli11=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_doubleconversion=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_eigen=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_expat=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_exprtk=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_fast_float=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_fmt=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_freetype=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_gl2ps=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_hdf5=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_ioss=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_jpeg=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_jsoncpp=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_libharu=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_libproj=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_libxml2=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_lz4=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_lzma=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_netcdf=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_nlohmannjson=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_ogg=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_pegtl=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_png=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_pugixml=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_scn=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_sqlite=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_theora=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_tiff=ON \
		-DVTK_MODULE_USE_EXTERNAL_VTK_token=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_utf8=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_verdict=OFF \
		-DVTK_MODULE_USE_EXTERNAL_VTK_zlib=ON
	cmake --build build
}

check() {
	xvfb-run -a ctest \
		--rerun-failed \
		--output-on-failure \
		-E 'FiltersCoreCxx-TestFeatureEdges' \
		--test-dir ./build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
fc8157a89fa603a7f7fce356e2f638ae69e0ea629a507458bdbb173daf511c61e39a1f0d7201b196a5b3a7ffa7e3e821398b62521faadf85edb1119a1e8b8e8e  VTK-9.5.2.tar.gz
1be895bed613ed0f0ace0ba5e138afacc3d61b57e437299b3aecf6beff702ad1a2d02036fd147853bbbcb6a1f9d20a51831c0263fdc5b8e62ece9a6f8f7d410e  VTKData-9.5.2.tar.gz
8d3dcbd8cc944e14c3dd22bad054e4398c5bfb10477d7a6e3accc97f3c39da2da46928a1c31e31500f199593e26b74423988dd5c390880d13544cae717a02ccc  disable-tests.patch
9d03601e4b33b2ee7f60d4eeddac27c04407c606bd42be386eadd5d2c043d81f64a34176358902dbcb4458bd5543158fa3c1c1c58b2d014cd1d184eafef949e2  external_fastfloat.patch
3914161f70bca79b438e8aba2f9c3185702ea7c251c1280b275188babb3254a60ab78953307cb93eb1d43060cf44cb3c5ce2f325573ba6df6864420f349e1206  loongarch64.patch
"
